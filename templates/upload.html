{% extends "base.html" %}

{% block title %}Upload & Analyze - ATS Resume Matcher{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="text-center mb-5">
                <h1 class="fw-bold mb-3">Upload & Analyze Resumes</h1>
                <p class="lead text-muted">
                    Upload your job description and candidate resumes to get comprehensive AI-powered analysis
                </p>
            </div>

            <!-- Upload Form -->
            <div class="card shadow-lg border-0">
                <div class="card-body p-4">
                    <form id="uploadForm" enctype="multipart/form-data">
                        <!-- Job Description Upload -->
                        <div class="mb-4">
                            <label for="jobDescription" class="form-label fw-bold">
                                <i class="fas fa-file-alt text-primary me-2"></i>Job Description (PDF)
                            </label>
                            <div class="upload-area" id="jdUploadArea" onclick="document.getElementById('jobDescription').click()">
                                <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                <h5>Drop your job description here</h5>
                                <p class="text-muted">or click to browse files</p>
                                <small class="text-muted">PDF format only • Max 16MB</small>
                            </div>
                            <input type="file" id="jobDescription" name="job_description" accept=".pdf" class="d-none" required>
                            <div id="jdFileInfo" class="mt-2"></div>
                        </div>

                        <!-- Resume Upload -->
                        <div class="mb-4">
                            <label for="resumes" class="form-label fw-bold">
                                <i class="fas fa-users text-success me-2"></i>Candidate Resumes (PDFs)
                            </label>
                            <div class="upload-area" id="resumeUploadArea" onclick="document.getElementById('resumes').click()">
                                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                                <h5>Drop candidate resumes here</h5>
                                <p class="text-muted">or click to browse files</p>
                                <small class="text-muted">Multiple PDF files • Max 16MB each</small>
                            </div>
                            <input type="file" id="resumes" name="resumes" accept=".pdf" multiple class="d-none" required>
                            <div id="resumeFileInfo" class="mt-2"></div>
                        </div>

                        <!-- Analysis Options -->
                        <div class="mb-4">
                            <h6 class="fw-bold mb-3">Analysis Options</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="marketAnalysis" checked>
                                        <label class="form-check-label" for="marketAnalysis">
                                            <strong>Market Trend Analysis</strong><br>
                                            <small class="text-muted">Analyze alignment with 2024-2025 tech trends</small>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="leadershipAnalysis" checked>
                                        <label class="form-check-label" for="leadershipAnalysis">
                                            <strong>Leadership Assessment</strong><br>
                                            <small class="text-muted">Detect leadership experience and achievements</small>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="qualityAnalysis" checked>
                                        <label class="form-check-label" for="qualityAnalysis">
                                            <strong>Resume Quality Check</strong><br>
                                            <small class="text-muted">Analyze writing quality and structure</small>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="differentiationAnalysis" checked>
                                        <label class="form-check-label" for="differentiationAnalysis">
                                            <strong>Competitive Differentiation</strong><br>
                                            <small class="text-muted">Identify unique candidate strengths</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="text-center">
                            <button type="submit" class="btn btn-primary btn-lg px-5" id="analyzeBtn">
                                <i class="fas fa-brain me-2"></i>Start AI Analysis
                            </button>
                            <div id="loadingSpinner" class="d-none mt-3">
                                <div class="spinner-custom mx-auto"></div>
                                <p class="mt-2 text-muted">Analyzing resumes... This may take a few minutes.</p>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Analysis Progress -->
            <div id="analysisProgress" class="card mt-4 d-none">
                <div class="card-body">
                    <h6 class="fw-bold mb-3">
                        <i class="fas fa-cog fa-spin me-2"></i>Analysis in Progress
                    </h6>
                    <div class="progress mb-3" style="height: 8px;">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             style="width: 0%"></div>
                    </div>
                    <div id="progressText" class="text-muted small">Initializing analysis...</div>
                </div>
            </div>

            <!-- Results Preview -->
            <div id="resultsPreview" class="card mt-4 d-none">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-check-circle me-2"></i>Analysis Complete!
                    </h6>
                </div>
                <div class="card-body">
                    <div id="resultsContent"></div>
                    <div class="text-center mt-3">
                        <a href="#" id="viewFullResults" class="btn btn-primary me-3">
                            <i class="fas fa-chart-bar me-2"></i>View Full Results
                        </a>
                        <a href="#" id="downloadResults" class="btn btn-outline-primary">
                            <i class="fas fa-download me-2"></i>Download CSV
                        </a>
                    </div>
                </div>
            </div>

            <!-- Instructions -->
            <div class="row mt-5">
                <div class="col-md-4">
                    <div class="text-center">
                        <div class="feature-icon mx-auto mb-3" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <i class="fas fa-upload"></i>
                        </div>
                        <h6 class="fw-bold">1. Upload Files</h6>
                        <p class="text-muted small">
                            Upload one job description PDF and multiple candidate resume PDFs. 
                            Files are processed locally for security.
                        </p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center">
                        <div class="feature-icon mx-auto mb-3" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                            <i class="fas fa-brain"></i>
                        </div>
                        <h6 class="fw-bold">2. AI Analysis</h6>
                        <p class="text-muted small">
                            Our AI analyzes skills, experience, market relevance, and competitive positioning 
                            across 6 dimensions in real-time.
                        </p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center">
                        <div class="feature-icon mx-auto mb-3" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <h6 class="fw-bold">3. Get Insights</h6>
                        <p class="text-muted small">
                            Receive comprehensive candidate rankings, market insights, and actionable 
                            recommendations for hiring decisions.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadForm = document.getElementById('uploadForm');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const analysisProgress = document.getElementById('analysisProgress');
    const resultsPreview = document.getElementById('resultsPreview');
    
    // File upload handling
    const jdInput = document.getElementById('jobDescription');
    const resumeInput = document.getElementById('resumes');
    const jdUploadArea = document.getElementById('jdUploadArea');
    const resumeUploadArea = document.getElementById('resumeUploadArea');
    
    // Drag and drop functionality
    [jdUploadArea, resumeUploadArea].forEach(area => {
        area.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('dragover');
        });
        
        area.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
        });
        
        area.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (this === jdUploadArea && files.length > 0) {
                jdInput.files = files;
                updateFileInfo('jd', files[0]);
            } else if (this === resumeUploadArea && files.length > 0) {
                resumeInput.files = files;
                updateFileInfo('resume', Array.from(files));
            }
        });
    });
    
    // File input change handlers
    jdInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            updateFileInfo('jd', this.files[0]);
        }
    });
    
    resumeInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            updateFileInfo('resume', Array.from(this.files));
        }
    });
    
    // Update file info display
    function updateFileInfo(type, files) {
        const infoDiv = document.getElementById(type === 'jd' ? 'jdFileInfo' : 'resumeFileInfo');
        
        if (type === 'jd') {
            infoDiv.innerHTML = `
                <div class="alert alert-success d-flex align-items-center">
                    <i class="fas fa-check-circle me-2"></i>
                    <span><strong>${files.name}</strong> (${formatFileSize(files.size)})</span>
                </div>
            `;
        } else {
            const fileList = files.map(file => 
                `<li class="d-flex justify-content-between align-items-center">
                    <span>${file.name}</span>
                    <small class="text-muted">${formatFileSize(file.size)}</small>
                </li>`
            ).join('');
            
            infoDiv.innerHTML = `
                <div class="alert alert-success">
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>${files.length} resume(s) selected</strong>
                    </div>
                    <ul class="list-unstyled mb-0">${fileList}</ul>
                </div>
            `;
        }
    }
    
    // Format file size
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // Form submission
    uploadForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Show loading state
        analyzeBtn.disabled = true;
        loadingSpinner.classList.remove('d-none');
        analysisProgress.classList.remove('d-none');
        resultsPreview.classList.add('d-none');
        
        try {
            // Step 1: Upload files
            updateProgress(20, 'Uploading files...');
            const formData = new FormData(uploadForm);
            const uploadResponse = await fetch('/api/upload', {
                method: 'POST',
                body: formData
            });
            
            if (!uploadResponse.ok) {
                throw new Error('File upload failed');
            }
            
            // Step 2: Start analysis
            updateProgress(50, 'Analyzing resumes with AI...');
            const analysisResponse = await fetch('/api/analyze', {
                method: 'POST'
            });
            
            if (!analysisResponse.ok) {
                throw new Error('Analysis failed');
            }
            
            const results = await analysisResponse.json();
            
            // Step 3: Show results
            updateProgress(100, 'Analysis complete!');
            setTimeout(() => {
                showResults(results);
                analysisProgress.classList.add('d-none');
            }, 1000);
            
        } catch (error) {
            console.error('Error:', error);
            updateProgress(0, 'Analysis failed. Please try again.');
            
            // Show error alert
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
            alertDiv.innerHTML = `
                <i class="fas fa-exclamation-circle me-2"></i>
                Analysis failed: ${error.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            uploadForm.appendChild(alertDiv);
        } finally {
            analyzeBtn.disabled = false;
            loadingSpinner.classList.add('d-none');
        }
    });
    
    // Update progress
    function updateProgress(percent, text) {
        document.getElementById('progressBar').style.width = percent + '%';
        document.getElementById('progressText').textContent = text;
    }
    
    // Show results
    function showResults(results) {
        const summary = results.summary;
        const candidates = results.results.candidates.slice(0, 3); // Top 3
        
        const resultsHTML = `
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <div class="text-center">
                        <h4 class="text-primary fw-bold">${summary.total_candidates}</h4>
                        <small class="text-muted">Candidates Analyzed</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h4 class="text-success fw-bold">${summary.top_score.toFixed(1)}%</h4>
                        <small class="text-muted">Top Score</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h4 class="text-warning fw-bold">${summary.average_score.toFixed(1)}%</h4>
                        <small class="text-muted">Average Score</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <h4 class="text-info fw-bold">&lt;2min</h4>
                        <small class="text-muted">Processing Time</small>
                    </div>
                </div>
            </div>
            
            <h6 class="fw-bold mb-3">Top Candidates:</h6>
            ${candidates.map((candidate, index) => `
                <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                    <div>
                        <strong>${index + 1}. ${candidate.candidate_name}</strong><br>
                        <small class="text-muted">${candidate.market_positioning?.tier || 'Developing'} • ${candidate.market_positioning?.market_readiness || 'Assessment Pending'}</small>
                    </div>
                    <div class="text-end">
                        <span class="score-badge ${getScoreClass(candidate.overall_score)}">${candidate.overall_score.toFixed(1)}%</span>
                    </div>
                </div>
            `).join('')}
        `;
        
        document.getElementById('resultsContent').innerHTML = resultsHTML;
        resultsPreview.classList.remove('d-none');
        
        // Update links
        document.getElementById('viewFullResults').href = '/results';
        document.getElementById('downloadResults').href = '/api/download-results';
    }
    
    // Get score class for styling
    function getScoreClass(score) {
        if (score >= 80) return 'score-excellent';
        if (score >= 60) return 'score-good';
        if (score >= 40) return 'score-fair';
        return 'score-poor';
    }
});
</script>
{% endblock %}
